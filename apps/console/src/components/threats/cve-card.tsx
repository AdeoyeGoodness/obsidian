import { Card, CardHeader } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { AlertTriangle, ExternalLink, Shield } from 'lucide-react'
import type { ThreatPrediction } from '@/lib/threat-model'

type CVECardProps = {
  id: string
  cvssScore: number
  affectedComponent: string
  cweId?: string
  description: string
  mappedCAPEC?: string[]
  predictions?: ThreatPrediction
  onViewDetails?: () => void
  onMitigate?: () => void
}

export function CVECard({
  id,
  cvssScore,
  affectedComponent,
  cweId,
  description,
  mappedCAPEC,
  predictions,
  onViewDetails,
  onMitigate,
}: CVECardProps) {
  const getCVSSColor = (score: number) => {
    if (score >= 9)
      return {
        bg: 'bg-red-500/20',
        text: 'text-red-300',
        border: 'border-red-500/30',
        glow: '0 0 20px rgba(239, 68, 68, 0.6)',
      }
    if (score >= 7)
      return {
        bg: 'bg-orange-500/20',
        text: 'text-orange-300',
        border: 'border-orange-500/30',
        glow: '0 0 20px rgba(251, 146, 60, 0.6)',
      }
    return {
      bg: 'bg-yellow-500/20',
      text: 'text-yellow-300',
      border: 'border-yellow-500/30',
      glow: '0 0 20px rgba(234, 179, 8, 0.6)',
    }
  }

  const cvssStyle = getCVSSColor(cvssScore)

  return (
    <Card
      className="relative"
      glow
      style={{
        boxShadow: cvssStyle.glow,
      }}
    >
      <CardHeader
        title={id}
        icon={<AlertTriangle size={18} />}
        action={
          <div
            className={`text-2xl font-bold px-4 py-2 rounded border ${cvssStyle.bg} ${cvssStyle.text} ${cvssStyle.border}`}
            style={{ boxShadow: cvssStyle.glow }}
          >
            {cvssScore.toFixed(1)}
          </div>
        }
      />

      <div className="space-y-4">
        <div>
          <p className="text-xs text-gray-500 uppercase tracking-wider mb-1">Affected Component</p>
          <p className="text-sm font-mono text-cyan-400">{affectedComponent}</p>
        </div>

        {cweId && (
          <div>
            <p className="text-xs text-gray-500 uppercase tracking-wider mb-1">CWE</p>
            <a
              href={`https://cwe.mitre.org/data/definitions/${cweId.replace('CWE-', '')}.html`}
              target="_blank"
              rel="noopener noreferrer"
              className="text-sm text-purple-400 hover:text-purple-300 flex items-center gap-2"
            >
              {cweId}
              <ExternalLink size={12} />
            </a>
          </div>
        )}

        <div>
          <p className="text-sm text-gray-300 leading-relaxed line-clamp-3">{description}</p>
        </div>

        {mappedCAPEC && mappedCAPEC.length > 0 && (
          <div>
            <p className="text-xs text-gray-500 uppercase tracking-wider mb-2">Mapped CAPEC</p>
            <div className="flex flex-wrap gap-2">
              {mappedCAPEC.map((capec) => (
                <span
                  key={capec}
                  className="text-xs px-2 py-1 rounded border border-purple-500/30 bg-purple-500/10 text-purple-300"
                >
                  {capec}
                </span>
              ))}
            </div>
          </div>
        )}

        {predictions && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3 pt-3 border-t border-gray-800">
            <div>
              <p className="text-xs text-gray-500 uppercase tracking-wider mb-2">Predicted CWE</p>
              <div className="flex flex-wrap gap-2">
                {predictions.cwe.length ? (
                  predictions.cwe.map((item) => (
                    <span
                      key={item.id}
                      className="text-xs px-2 py-1 rounded border border-cyan-500/30 bg-cyan-500/10 text-cyan-200"
                    >
                      {item.id}
                      {typeof item.score === 'number' ? ` (${(item.score * 100).toFixed(0)}%)` : ''}
                    </span>
                  ))
                ) : (
                  <span className="text-xs text-gray-500">No predictions</span>
                )}
              </div>
            </div>
            <div>
              <p className="text-xs text-gray-500 uppercase tracking-wider mb-2">Predicted CAPEC</p>
              <div className="flex flex-wrap gap-2">
                {predictions.capec.length ? (
                  predictions.capec.map((item) => (
                    <span
                      key={item.id}
                      className="text-xs px-2 py-1 rounded border border-purple-500/30 bg-purple-500/10 text-purple-200"
                    >
                      {item.id}
                      {typeof item.score === 'number' ? ` (${(item.score * 100).toFixed(0)}%)` : ''}
                    </span>
                  ))
                ) : (
                  <span className="text-xs text-gray-500">No predictions</span>
                )}
              </div>
            </div>
          </div>
        )}

        <div className="flex gap-2 pt-3 border-t border-gray-800">
          {onViewDetails && (
            <Button
              onClick={onViewDetails}
              icon={<ExternalLink size={14} />}
              size="sm"
              intent="ghost"
              className="border-gray-700 text-gray-300"
            >
              View Details
            </Button>
          )}
          {onMitigate && (
            <Button
              onClick={onMitigate}
              icon={<Shield size={14} />}
              size="sm"
              className="border-emerald-500 text-emerald-400 hover:bg-emerald-500/10"
            >
              Mitigate
            </Button>
          )}
        </div>
      </div>
    </Card>
  );
}

